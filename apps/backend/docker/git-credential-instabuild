#!/bin/sh
# Git credential helper for InstaBuild sandboxes
# This script requests GitHub credentials from the backend service

# Read git's credential request (e.g., "protocol=https\nhost=github.com")
while IFS= read -r line; do
  case "$line" in
    "") break ;;
    protocol=*) protocol="${line#protocol=}" ;;
    host=*) host="${line#host=}" ;;
  esac
done

# Only provide credentials for GitHub
if [ "$host" != "github.com" ]; then
  exit 0
fi

# Request credentials from backend
# Backend validates SANDBOX_ID to ensure request is from legitimate sandbox
RESPONSE=$(curl -s -f \
  -H "X-Sandbox-ID: ${SANDBOX_ID}" \
  -H "X-User-ID: ${USER_ID}" \
  http://host.docker.internal:3330/api/v1/internal/credentials/github)

if [ $? -eq 0 ] && [ -n "$RESPONSE" ]; then
  # Output credentials in git credential format
  echo "protocol=https"
  echo "host=github.com"
  echo "username=${RESPONSE}"
  echo "password=${RESPONSE}"
fi
